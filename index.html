<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Speech Recognition Sample</title>
</head>
<body>
<div>
<button id="start">認識開始</button>
</div>
<div style="width=100%;">
<textarea id="result" style="width:100%;" rows="10"></textarea>
</div>
<div style="width=100%;">
<textarea id="status" style="width:100%;" rows="10"></textarea>
</div>

<script>
window.addEventListener('DOMContentLoaded', (ev) => {
  const startButton = document.getElementById('start')
  const resultArea = document.getElementById('result')
  const statusArea = document.getElementById('status')
  const setResult = (text) => { resultArea.textContent = text }
  const recognizer =
    ('SpeechRecognition' in window) ? new SpeechRecognition() : 
    ('webkitSpeechRecognition' in window) ? new webkitSpeechRecognition() :
    null
  if (recognizer == null) {
    setResult('ブラウザが音声認識に対応していません。')
    return
  }
  const addLog = (message) => {
    statusArea.textContent = message + '\n' + statusArea.textContent
  }
  recognizer.continuous = false
  recognizer.interimResults = false
  recognizer.lang = 'ja'

  recognizer.onstart = () => { addLog('on-start') }
  recognizer.onaudiostart = () => { addLog('on-audio-start') }
  recognizer.onsoundstart = () => { addLog('on-audio-start') }
  recognizer.onspeechstart = () => { addLog('on-speech-start') }
  recognizer.onspeechend = () => { addLog('on-speech-end') }
  recognizer.onsoundend = () => { addLog('on-sound-end') }
  recognizer.onaudioend = () => { addLog('on-audio-end') }
  recognizer.onend = () => { addLog('on-end') }

  recognizer.onerror = (ev) => { addLog(`on-error : ${ev}`) }
  recognizer.onnomatch = () => { addLog('on-no-match') }

  recognizer.onresult = (ev) => {
    addLog(`on-result : resultIndex=${ev.resultIndex} #=${ev.results.length}`)
    phrase = ''
    for (let i=0 ; i<ev.results.length ; i++) {
      addLog(`result(${i}) final:${ev.results[i].isFinal} text:${ev.results[i][0].transcript}`)
      phrase += ev.results[i][0].transcript + '。'
    }
    setResult(phrase)
    startButton.disabled = false
  }

  startButton.addEventListener('click', (ev) => {
    recognizer.start()
    startButton.disabled = true
  })
})
</script>

</body>
</html>
